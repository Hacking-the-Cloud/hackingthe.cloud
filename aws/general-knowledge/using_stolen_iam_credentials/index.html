<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="How to work with stolen IAM credentials and things to consider."><meta name=author content="Nick Frichette"><link href=https://hackingthe.cloud/aws/general-knowledge/using_stolen_iam_credentials/ rel=canonical><link rel=icon href=../../../images/logo.png><meta name=generator content="mkdocs-1.4.2, mkdocs-material-8.5.11+insiders-4.26.6"><title>Using Stolen IAM Credentials - Hacking The Cloud</title><link rel=stylesheet href=../../../assets/stylesheets/main.e9638a90.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.2505c338.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><meta property=og:type content=website><meta property=og:title content="Using Stolen IAM Credentials - Hacking The Cloud"><meta property=og:description content="How to work with stolen IAM credentials and things to consider."><meta property=og:image content=https://hackingthe.cloud/assets/images/social/aws/general-knowledge/using_stolen_iam_credentials.png><meta property=og:image:type content=image/png><meta property=og:image:width content=1200><meta property=og:image:height content=630><meta content=https://hackingthe.cloud/aws/general-knowledge/using_stolen_iam_credentials/ property=og:url><meta name=twitter:card content=summary_large_image><meta name=twitter:title content="Using Stolen IAM Credentials - Hacking The Cloud"><meta name=twitter:description content="How to work with stolen IAM credentials and things to consider."><meta name=twitter:image content=https://hackingthe.cloud/assets/images/social/aws/general-knowledge/using_stolen_iam_credentials.png></head> <body dir=ltr data-md-color-scheme=slate data-md-color-primary=red data-md-color-accent> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#iam-credential-characteristics class=md-skip> Skip to content </a> </div> <div data-md-component=announce> <aside class=md-banner> <div class="md-banner__inner md-grid md-typeset"> <a href=https://twitter.com/Frichette_n style=color:white> For updates follow <strong>@frichette_n</strong> on <span class="twemoji twitter"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg> </span> <strong>Twitter</strong> </a> <a hidden disabled rel=me href=https://infosec.exchange/@hackingthecloud>Mastodon</a> </div> </aside> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../.. title="Hacking The Cloud" class="md-header__button md-logo" aria-label="Hacking The Cloud" data-md-component=logo> <img src=../../../images/logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Hacking The Cloud </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Using Stolen IAM Credentials </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=red data-md-color-accent aria-label="Switch to Dark Mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to Dark Mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=red data-md-color-accent aria-label="Switch to Light Mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to Light Mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg> </label> </form> <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/Hacking-the-Cloud/hackingthe.cloud title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </div> <div class=md-source__repository> Hacking The Cloud </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> Hacking The Cloud </a> </li> <li class=md-tabs__item> <a href=../aws_organizations_defaults/ class="md-tabs__link md-tabs__link--active"> AWS </a> </li> <li class=md-tabs__item> <a href=../../../azure/abusing-managed-identities/ class=md-tabs__link> Azure </a> </li> <li class=md-tabs__item> <a href=../../../gcp/general-knowledge/client-credential-search-order/ class=md-tabs__link> GCP </a> </li> <li class=md-tabs__item> <a href=../../../terraform/terraform_ansi_escape_evasion/ class=md-tabs__link> Terraform </a> </li> <li class=md-tabs__item> <a href=../../../blog/v2_new_look/ class=md-tabs__link> Blog </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title="Hacking The Cloud" class="md-nav__button md-logo" aria-label="Hacking The Cloud" data-md-component=logo> <img src=../../../images/logo.png alt=logo> </a> Hacking The Cloud </label> <div class=md-nav__source> <a href=https://github.com/Hacking-the-Cloud/hackingthe.cloud title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </div> <div class=md-source__repository> Hacking The Cloud </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> <span class=md-ellipsis> Hacking The Cloud </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2> <span class=md-ellipsis> AWS </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=AWS data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> AWS </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_1 type=checkbox id=__nav_2_1 checked> <label class=md-nav__link for=__nav_2_1> <span class=md-ellipsis> General Knowledge </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="General Knowledge" data-md-level=2> <label class=md-nav__title for=__nav_2_1> <span class="md-nav__icon md-icon"></span> General Knowledge </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../aws_organizations_defaults/ class=md-nav__link> <span class=md-ellipsis> AWS Organizations Defaults </span> </a> </li> <li class=md-nav__item> <a href=../connection-tracking/ class=md-nav__link> <span class=md-ellipsis> Connection Tracking </span> </a> </li> <li class=md-nav__item> <a href=../create_a_console_session_from_iam_credentials/ class=md-nav__link> <span class=md-ellipsis> Create a Console Session from IAM Credentials </span> </a> </li> <li class=md-nav__item> <a href=../iam-key-identifiers/ class=md-nav__link> <span class=md-ellipsis> IAM ID Identifiers </span> </a> </li> <li class=md-nav__item> <a href=../intro_metadata_service/ class=md-nav__link> <span class=md-ellipsis> Introduction to the Instance Metadata Service </span> </a> </li> <li class=md-nav__item> <a href=../introduction_user_data/ class=md-nav__link> <span class=md-ellipsis> Introduction to User Data </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Using Stolen IAM Credentials </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Using Stolen IAM Credentials </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#iam-credential-characteristics class=md-nav__link> <span class=md-ellipsis> IAM Credential Characteristics </span> </a> </li> <li class=md-nav__item> <a href=#working-with-the-keys class=md-nav__link> <span class=md-ellipsis> Working with the Keys </span> </a> </li> <li class=md-nav__item> <a href=#determining-validity class=md-nav__link> <span class=md-ellipsis> Determining Validity </span> </a> <nav class=md-nav aria-label="Determining Validity"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#operational-security-considerations class=md-nav__link> <span class=md-ellipsis> Operational Security Considerations </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#avoiding-detection class=md-nav__link> <span class=md-ellipsis> Avoiding Detection </span> </a> <nav class=md-nav aria-label="Avoiding Detection"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#guardduty-pentest-findings-and-cli-user-agents class=md-nav__link> <span class=md-ellipsis> GuardDuty Pentest Findings and CLI User Agents </span> </a> </li> <li class=md-nav__item> <a href=#guardduty-credential-exfiltration class=md-nav__link> <span class=md-ellipsis> GuardDuty Credential Exfiltration </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#situational-awareness class=md-nav__link> <span class=md-ellipsis> Situational Awareness </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_2 type=checkbox id=__nav_2_2> <label class=md-nav__link for=__nav_2_2> <span class=md-ellipsis> Enumeration </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Enumeration data-md-level=2> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> Enumeration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../enumeration/account_id_from_ec2/ class=md-nav__link> <span class=md-ellipsis> Enumerate AWS Account ID from an EC2 Instance </span> </a> </li> <li class=md-nav__item> <a href=../../enumeration/account_id_from_s3_bucket/ class=md-nav__link> <span class=md-ellipsis> Enumerate AWS Account ID from a Public S3 Bucket </span> </a> </li> <li class=md-nav__item> <a href=../../enumeration/brute_force_iam_permissions/ class=md-nav__link> <span class=md-ellipsis> Brute Force IAM Permissions </span> </a> </li> <li class=md-nav__item> <a href=../../enumeration/enum_iam_user_role/ class=md-nav__link> <span class=md-ellipsis> Unauthenticated Enumeration of IAM Users and Roles </span> </a> </li> <li class=md-nav__item> <a href=../../enumeration/get-account-id-from-keys/ class=md-nav__link> <span class=md-ellipsis> Get Account ID from AWS Access Keys </span> </a> </li> <li class=md-nav__item> <a href=../../enumeration/whoami/ class=md-nav__link> <span class=md-ellipsis> Whoami - Get Principal Name From Keys </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_3 type=checkbox id=__nav_2_3> <label class=md-nav__link for=__nav_2_3> <span class=md-ellipsis> Exploitation </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Exploitation data-md-level=2> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> Exploitation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../exploitation/abusing-container-registry/ class=md-nav__link> <span class=md-ellipsis> Abusing Elastic Container Registry for Lateral Movement </span> </a> </li> <li class=md-nav__item> <a href=../../exploitation/ec2-metadata-ssrf/ class=md-nav__link> <span class=md-ellipsis> Steal EC2 Metadata Credentials via SSRF </span> </a> </li> <li class=md-nav__item> <a href=../../exploitation/iam_privilege_escalation/ class=md-nav__link> <span class=md-ellipsis> AWS IAM Privilege Escalation Techniques </span> </a> </li> <li class=md-nav__item> <a href=../../exploitation/lambda-steal-iam-credentials/ class=md-nav__link> <span class=md-ellipsis> Steal IAM Credentials and Event Data from Lambda </span> </a> </li> <li class=md-nav__item> <a href=../../exploitation/local-priv-esc-mod-instance-att/ class=md-nav__link> <span class=md-ellipsis> Local Privilege Escalation: User Data </span> </a> </li> <li class=md-nav__item> <a href=../../exploitation/local-priv-esc-user-data-s3/ class=md-nav__link> <span class=md-ellipsis> Local Privilege Escalation: User Data 2 </span> </a> </li> <li class=md-nav__item> <a href=../../exploitation/orphaned_%20cloudfront_or_dns_takeover_via_s3/ class=md-nav__link> <span class=md-ellipsis> Simple Route53/Cloudfront/S3 Subdomain Takeover </span> </a> </li> <li class=md-nav__item> <a href=../../exploitation/route53_modification_privilege_escalation/ class=md-nav__link> <span class=md-ellipsis> AWS API Call Hijacking via ACM-PCA </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_3_9 type=checkbox id=__nav_2_3_9> <div class="md-nav__link md-nav__container"> <a href=../../exploitation/Misconfigured_Resource-Based_Policies/ class="md-nav__link "> <span class=md-ellipsis> Misconfigured Resource Based Policies </span> </a> <label class="md-nav__link " for=__nav_2_3_9> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="Misconfigured Resource Based Policies" data-md-level=3> <label class=md-nav__title for=__nav_2_3_9> <span class="md-nav__icon md-icon"></span> Misconfigured Resource Based Policies </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../exploitation/Misconfigured_Resource-Based_Policies/misconfigured_ecr_resource_policy/ class=md-nav__link> <span class=md-ellipsis> Abusing Misconfigured ECR Resource Policies </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_4 type=checkbox id=__nav_2_4> <label class=md-nav__link for=__nav_2_4> <span class=md-ellipsis> Avoid Detection </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Avoid Detection" data-md-level=2> <label class=md-nav__title for=__nav_2_4> <span class="md-nav__icon md-icon"></span> Avoid Detection </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../avoiding-detection/guardduty-pentest/ class=md-nav__link> <span class=md-ellipsis> Bypass GuardDuty Pentest Findings </span> </a> </li> <li class=md-nav__item> <a href=../../avoiding-detection/guardduty-tor-client/ class=md-nav__link> <span class=md-ellipsis> Bypass GuardDuty Tor Client Findings </span> </a> </li> <li class=md-nav__item> <a href=../../avoiding-detection/modify-guardduty-config/ class=md-nav__link> <span class=md-ellipsis> Modify GuardDuty Configuration </span> </a> </li> <li class=md-nav__item> <a href=../../avoiding-detection/steal-keys-undetected/ class=md-nav__link> <span class=md-ellipsis> Bypass Credential Exfiltration Detection </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_5 type=checkbox id=__nav_2_5> <label class=md-nav__link for=__nav_2_5> <span class=md-ellipsis> Post Exploitation </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Post Exploitation" data-md-level=2> <label class=md-nav__title for=__nav_2_5> <span class="md-nav__icon md-icon"></span> Post Exploitation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../post_exploitation/get_iam_creds_from_console_session/ class=md-nav__link> <span class=md-ellipsis> Get IAM Credentials from a Console Session </span> </a> </li> <li class=md-nav__item> <a href=../../post_exploitation/intercept_ssm_communications/ class=md-nav__link> <span class=md-ellipsis> Intercept SSM Communications </span> </a> </li> <li class=md-nav__item> <a href=../../post_exploitation/lambda_persistence/ class=md-nav__link> <span class=md-ellipsis> Lambda Persistence </span> </a> </li> <li class=md-nav__item> <a href=../../post_exploitation/role-chain-juggling/ class=md-nav__link> <span class=md-ellipsis> Role Chain Juggling </span> </a> </li> <li class=md-nav__item> <a href=../../post_exploitation/run_shell_commands_on_ec2/ class=md-nav__link> <span class=md-ellipsis> Run Shell Commands on EC2 with Send Command or Session Manager </span> </a> </li> <li class=md-nav__item> <a href=../../post_exploitation/s3_acl_persistence/ class=md-nav__link> <span class=md-ellipsis> S3 File ACL Persistence </span> </a> </li> <li class=md-nav__item> <a href=../../post_exploitation/user_data_script_persistence/ class=md-nav__link> <span class=md-ellipsis> User Data Script Persistence </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_6 type=checkbox id=__nav_2_6> <label class=md-nav__link for=__nav_2_6> <span class=md-ellipsis> Deprecated </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Deprecated data-md-level=2> <label class=md-nav__title for=__nav_2_6> <span class="md-nav__icon md-icon"></span> Deprecated </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../deprecated/stealth_perm_enum/ class=md-nav__link> <span class=md-ellipsis> Enumerate Permissions without Logging to CloudTrail </span> </a> </li> <li class=md-nav__item> <a href=../../deprecated/whoami/ class=md-nav__link> <span class=md-ellipsis> Whoami - Get Principal Name From Keys </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_7 type=checkbox id=__nav_2_7> <label class=md-nav__link for=__nav_2_7> <span class=md-ellipsis> Capture the Flag </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Capture the Flag" data-md-level=2> <label class=md-nav__title for=__nav_2_7> <span class="md-nav__icon md-icon"></span> Capture the Flag </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../capture_the_flag/cicdont/ class=md-nav__link> <span class=md-ellipsis> CI/CDon't </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3> <span class=md-ellipsis> Azure </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Azure data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Azure </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../azure/abusing-managed-identities/ class=md-nav__link> <span class=md-ellipsis> Abusing Managed Identities </span> </a> </li> <li class=md-nav__item> <a href=../../../azure/anonymous-blob-access/ class=md-nav__link> <span class=md-ellipsis> Anonymous Blob Access </span> </a> </li> <li class=md-nav__item> <a href=../../../azure/soft-deleted-blobs/ class=md-nav__link> <span class=md-ellipsis> Soft Deleted Blobs </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4> <span class=md-ellipsis> GCP </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=GCP data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> GCP </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_1 type=checkbox id=__nav_4_1> <label class=md-nav__link for=__nav_4_1> <span class=md-ellipsis> General Knowledge </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="General Knowledge" data-md-level=2> <label class=md-nav__title for=__nav_4_1> <span class="md-nav__icon md-icon"></span> General Knowledge </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../gcp/general-knowledge/client-credential-search-order/ class=md-nav__link> <span class=md-ellipsis> Client Credential Search Order </span> </a> </li> <li class=md-nav__item> <a href=../../../gcp/general-knowledge/default-account-names/ class=md-nav__link> <span class=md-ellipsis> Default Account Information </span> </a> </li> <li class=md-nav__item> <a href=../../../gcp/general-knowledge/gcp-buckets/ class=md-nav__link> <span class=md-ellipsis> Hunting GCP Buckets </span> </a> </li> <li class=md-nav__item> <a href=../../../gcp/general-knowledge/metadata_in_google_cloud_instances/ class=md-nav__link> <span class=md-ellipsis> Metadata in Google Cloud Instances </span> </a> </li> <li class=md-nav__item> <a href=../../../gcp/general-knowledge/security-and-constraints/ class=md-nav__link> <span class=md-ellipsis> Security and Constraints </span> </a> </li> <li class=md-nav__item> <a href=../../../gcp/general-knowledge/security-concepts/ class=md-nav__link> <span class=md-ellipsis> Security Concepts </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_2 type=checkbox id=__nav_4_2> <label class=md-nav__link for=__nav_4_2> <span class=md-ellipsis> Enumeration </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Enumeration data-md-level=2> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> Enumeration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../gcp/enumeration/enumerate_service_account_permissions/ class=md-nav__link> <span class=md-ellipsis> Enumerate Service Account Permissions </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_3 type=checkbox id=__nav_4_3> <label class=md-nav__link for=__nav_4_3> <span class=md-ellipsis> Exploitation </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Exploitation data-md-level=2> <label class=md-nav__title for=__nav_4_3> <span class="md-nav__icon md-icon"></span> Exploitation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../gcp/exploitation/gcp-metadata-ssrf/ class=md-nav__link> <span class=md-ellipsis> Steal an OAuth Token via SSRF </span> </a> </li> <li class=md-nav__item> <a href=../../../gcp/exploitation/gcp-priv-esc/ class=md-nav__link> <span class=md-ellipsis> GCP Privilege Escalation </span> </a> </li> <li class=md-nav__item> <a href=../../../gcp/exploitation/gcp_iam_privilege_escalation/ class=md-nav__link> <span class=md-ellipsis> Privilege Escalation in Google Cloud Platform </span> </a> </li> <li class=md-nav__item> <a href=../../../gcp/exploitation/local-priv-esc-metadata/ class=md-nav__link> <span class=md-ellipsis> Local Privilege Escalation: Modifying the Metadata </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_4 type=checkbox id=__nav_4_4> <label class=md-nav__link for=__nav_4_4> <span class=md-ellipsis> Post Exploitation </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Post Exploitation" data-md-level=2> <label class=md-nav__title for=__nav_4_4> <span class="md-nav__icon md-icon"></span> Post Exploitation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../gcp/post_exploitation/lateral-movement/ class=md-nav__link> <span class=md-ellipsis> Lateral Movement </span> </a> </li> <li class=md-nav__item> <a href=../../../gcp/post_exploitation/treasure_hunting/ class=md-nav__link> <span class=md-ellipsis> Treasure hunting </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_5 type=checkbox id=__nav_4_5> <label class=md-nav__link for=__nav_4_5> <span class=md-ellipsis> Tools </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Tools data-md-level=2> <label class=md-nav__title for=__nav_4_5> <span class="md-nav__icon md-icon"></span> Tools </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../gcp/tools/gcloud/ class=md-nav__link> <span class=md-ellipsis> Google Cloud CLI </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_6 type=checkbox id=__nav_4_6> <label class=md-nav__link for=__nav_4_6> <span class=md-ellipsis> Capture the Flag </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Capture the Flag" data-md-level=2> <label class=md-nav__title for=__nav_4_6> <span class="md-nav__icon md-icon"></span> Capture the Flag </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../gcp/capture_the_flag/gcp-goat/ class=md-nav__link> <span class=md-ellipsis> GCP Goat </span> </a> </li> <li class=md-nav__item> <a href=../../../gcp/capture_the_flag/thunder_ctf/ class=md-nav__link> <span class=md-ellipsis> Thunder CTF </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5 type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5> <span class=md-ellipsis> Terraform </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Terraform data-md-level=1> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Terraform </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../terraform/terraform_ansi_escape_evasion/ class=md-nav__link> <span class=md-ellipsis> Terraform ANSI Escape </span> </a> </li> <li class=md-nav__item> <a href=../../../terraform/terraform_enterprise_metadata_service/ class=md-nav__link> <span class=md-ellipsis> Terraform Enterprise: Attack the Metadata Service </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6 type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6> <span class=md-ellipsis> Blog </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Blog data-md-level=1> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Blog </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../blog/v2_new_look/ class=md-nav__link> <span class=md-ellipsis> Hacking The Cloud v2: New Look </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#iam-credential-characteristics class=md-nav__link> <span class=md-ellipsis> IAM Credential Characteristics </span> </a> </li> <li class=md-nav__item> <a href=#working-with-the-keys class=md-nav__link> <span class=md-ellipsis> Working with the Keys </span> </a> </li> <li class=md-nav__item> <a href=#determining-validity class=md-nav__link> <span class=md-ellipsis> Determining Validity </span> </a> <nav class=md-nav aria-label="Determining Validity"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#operational-security-considerations class=md-nav__link> <span class=md-ellipsis> Operational Security Considerations </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#avoiding-detection class=md-nav__link> <span class=md-ellipsis> Avoiding Detection </span> </a> <nav class=md-nav aria-label="Avoiding Detection"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#guardduty-pentest-findings-and-cli-user-agents class=md-nav__link> <span class=md-ellipsis> GuardDuty Pentest Findings and CLI User Agents </span> </a> </li> <li class=md-nav__item> <a href=#guardduty-credential-exfiltration class=md-nav__link> <span class=md-ellipsis> GuardDuty Credential Exfiltration </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#situational-awareness class=md-nav__link> <span class=md-ellipsis> Situational Awareness </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <p>Article by Nick Frichette.</p> <a href=https://github.com/Hacking-the-Cloud/hackingthe.cloud/edit/main/content/aws/general-knowledge/using_stolen_iam_credentials.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg> </a> <h1>Using Stolen IAM Credentials</h1> <p>As a Penetration Tester or Red Teamer it is likely you will stumble into AWS IAM credentials during an assessment. The following is a step by step guide on how you can use them, things to consider, and methods to avoid detection.</p> <h2 id=iam-credential-characteristics>IAM Credential Characteristics</h2> <p>In AWS there are typically two types of credentials you will be working with, <a href=https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html>long term</a> (access keys) and <a href=https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_temp.html>short term</a>.</p> <p>Long term credentials will have an access key that starts with <code>AKIA</code> and will be 20 characters long. In addition to the access key there will also be a secret access key which is 40 characters long. With these two keys, you can potentially make requests against the AWS API. As the name implies, these credentials have no specified lifespan and will be useable until they are intentionally disabled/deactivated. As a result, this makes them not recommended from a security perspective. Temporary security credentials are preferred.</p> <p>Temporary credentials, by comparison, will have an access key that starts with <code>ASIA</code>, be 20 characters long, and also have a 40 character secret key. In addition, temporary security credentials will also have a session token (sometimes referred to as a security token). The session token will be base64 encoded and quite long. With these 3 credentials combined you can potentially make requests to the AWS API. As the name implies, these credentials have a temporary lifespan that is determined when they were created. It can be as short as 15 minutes, and as long as several hours.</p> <h2 id=working-with-the-keys>Working with the Keys</h2> <p>After gathering the credentials you will likely want to use them with the AWS CLI. There are a <a href=https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-quickstart.html>few</a> ways to do this, however setting them as environment variables is likely the easiest. </p> <p>To do this with long term credentials, set the following environment variables.</p> <div class=highlight><pre><span></span><code>export AWS_ACCESS_KEY_ID=AKIAEXAMPLEEXAMPLEEE
export AWS_SECRET_ACCESS_KEY=EXAMPLEEXAMPLEEXAMPLEEXAMPLEEXAMPLESEXAM
</code></pre></div> <p>To do this with short term credentials, set the following environment variables.</p> <div class=highlight><pre><span></span><code>export AWS_ACCESS_KEY_ID=ASIAEXAMPLEEXAMPLEEE
export AWS_SECRET_ACCESS_KEY=EXAMPLEEXAMPLEEXAMPLEEXAMPLEEXAMPLESEXAM
export AWS_SESSION_TOKEN=EXAMPLEEXAMPLEEXAMPLE...&lt;snip&gt;
</code></pre></div> <div class="admonition note"> <p class=admonition-title>Note</p> <p>You may also have to specify an AWS region. This can be globally set with the <code>aws configure</code> command or through the <code>AWS_REGION</code> environment variable.</p> </div> <h2 id=determining-validity>Determining Validity</h2> <p>Now that you have credentials and have them setup to use, how can you determine if they are valid (not expired or deactivated)? The simplest way would be to make use of the <a href=https://awscli.amazonaws.com/v2/documentation/api/latest/reference/sts/get-caller-identity.html>sts:GetCallerIdentity</a> API call. This method is helpful because it will allow us to determine if the credentials are valid and it will also tell us useful information such as the name of the role/user associated with these credentials and the AWS account ID they belong to.</p> <p>As an added bonus, we can be confident this API call will always work. From the documentation, "No permissions are required to perform this operation. If an administrator adds a policy to your IAM user or role that explicitly denies access to the sts:GetCallerIdentity action, you can still perform this operation".</p> <div class=highlight><pre><span></span><code>$ aws sts get-caller-identity
{
    &quot;UserId&quot;: &quot;AROAEXAMPLEEXAMPLEEXA:Nick&quot;,
    &quot;Account&quot;: &quot;123456789123&quot;,
    &quot;Arn&quot;: &quot;arn:aws:sts::123456789123:assumed-role/blah/Nick&quot;
}
</code></pre></div> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>For defensive security professionals, it may be worthwhile to alert on invocations of <code>sts:GetCallerIdentity</code> from identities that have no history of calling it. For example, if an application server in a production environment has never called it before, that may be an indication of compromise.</p> <p>It is worth noting that <code>sts:GetCallerIdentity</code> may be <a href=https://twitter.com/SpenGietz/status/1283846678194221057>legitimately used</a> by a large number of projects, and that individual developers may use it as well. To attempt to reduce the number of false positives, it would be best to only alert on identities which have no history of calling it.</p> </div> <h3 id=operational-security-considerations>Operational Security Considerations</h3> <p>If you are attempting to maintain stealth, <code>sts:GetCallerIdentity</code> may be a risk. This API call logs to <a href=https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-user-guide.html>CloudTrail</a> which means that defenders will have a log with additional details that this occurred. To get around this, we can make use of <a href=https://aws.amazon.com/premiumsupport/knowledge-center/cloudtrail-data-management-events/ >data events</a>.</p> <p>Data events are high-volume API calls for resources in an AWS account. Because of the number of times these APIs may be called, they are not logged to CloudTrail by default and in some cases they cannot be logged at all.</p> <p>An example of this would be <a href=/aws/enumeration/whoami/#sns-publish>sns:Publish</a>. By making this API call (and supplying a valid AWS account ID) we can get similar information as <code>sts:GetCallerIdentity</code>.</p> <div class=highlight><pre><span></span><code>$ aws sns publish --topic-arn arn:aws:sns:us-east-1:*account id*:aaa --message aaa

An error occurred (AuthorizationError) when calling the Publish operation: User: arn:aws:sts::123456789123:assumed-role/example_role/i-00000000000000000 is not authorized to perform: SNS:Publish on resource: arn:aws:sns:us-east-1:*account id*:aaa
</code></pre></div> <p>For more information on this technique, please see its <a href=/aws/enumeration/whoami/ >article</a>.</p> <h2 id=avoiding-detection>Avoiding Detection</h2> <p>There are situations where simply using the credentials could alert defenders to your presence. As a result, it is a good idea to be mindful of these circumstances to avoid being caught.</p> <h3 id=guardduty-pentest-findings-and-cli-user-agents>GuardDuty Pentest Findings and CLI User Agents</h3> <p>If you are using a "pentesting" Linux distribution such as <a href=https://www.kali.org/ >Kali Linux</a>, <a href=https://www.parrotsec.org/ >Parrot Security</a>, or <a href=https://www.pentoo.ch/ >Pentoo Linux</a> you will immediately trigger a <a href=https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-iam.html#pentest-iam-kalilinux>PenTest GuardDuty finding</a>. This is because the AWS CLI will send along a user agent string which contains information about the operating system making the API call.</p> <p>In order to avoid this, it is best to make use of a "safe" operating system, such as Windows, Mac OS, or Ubuntu. If you are short on time, or simply MUST use one of these Linux distributions, you can modify your <a href=https://github.com/boto/botocore>botocore</a> library with a hard-coded user agent.</p> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>Are you going up against an apex blue team who will detect anything? It may be a good idea to spoof a user agent string that one would expect in the environment. For example, if these IAM credentials belong to a developer who uses a Windows workstation, it would be very strange for API calls to suddenly start having a user agent with a Linux operating system.</p> <p>Defenders, this may also be worth looking into for detection purposes.</p> </div> <p>For more information on this, please see its <a href=/aws/avoiding-detection/guardduty-pentest/ >article</a>.</p> <h3 id=guardduty-credential-exfiltration>GuardDuty Credential Exfiltration</h3> <div class="admonition note"> <p class=admonition-title>Note</p> <p>This section only applies to IAM credentials taken from the <a href=/aws/general-knowledge/intro_metadata_service/ >Instance Metadata Service</a> of an EC2 instance. It does not apply to other IAM credentials.</p> </div> <p>When using IAM credentials taken from an EC2 instance, you run the risk of triggering the <a href=https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws>UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS</a> GuardDuty finding. This finding alerts on scenarios in which IAM credentials from an EC2 instance are used from outside AWS (E.X your home IP address).</p> <p>This is particularly relevant in scenarios in which you have access to the IAM credentials, but not the host (<a href=https://portswigger.net/web-security/ssrf>Server Side Request Forgery</a>).</p> <p>To get around this, we can make use of <a href=https://docs.aws.amazon.com/vpc/latest/privatelink/concepts.html>VPC Endpoints</a> which will not trigger this alert. To make things easier, the <a href=https://github.com/Frichetten/SneakyEndpoints>SneakyEndpoints</a> tool was developed to allow you to quickly stand up infrastructure to bypass this detection.</p> <p>For more information on this, please see its <a href=/aws/avoiding-detection/steal-keys-undetected/ >article</a>.</p> <h2 id=situational-awareness>Situational Awareness</h2> <p>Now that you have everything set up and you know what to look out for, your next question may be, "what is in this AWS account?". If you are performing a no-knowledge assessment, and thus, don't have any insights into what services are running in the account, it makes it difficult to know what to target or look into.</p> <p>One option would be to <a href=/aws/enumeration/enum_iam_user_role/ >enumerate the service-linked roles</a> in the account. A <a href=https://docs.aws.amazon.com/IAM/latest/UserGuide/using-service-linked-roles.html>service-linked</a> role is a special kind of IAM role that allows an AWS service to perform actions in your account. Because of this, we can potentially enumerate them without authentication. </p> <p>From the previous validity checking step, we will know the AWS account ID we are operating in. That, combined with <a href=/aws/enumeration/enum_iam_user_role/ >this</a> technique will allow us to enumerate what services the AWS account uses. This can be helpful to answer questions such as, "Is our target using GuardDuty? Is this account a part of an organization? Are they using containers (ECS, EKS), or are they using EC2?".</p> <p>For more information on this, please see its <a href=/aws/enumeration/enum_iam_user_role/ >article</a>.</p> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title="Date of last update"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1-2.1-2M12.5 7v5.2l4 2.4-1 1L11 13V7h1.5M11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2v1.8Z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">May 15, 2022</span> </span> <span class=md-source-file__fact> <span class=md-icon title="Date of creation"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3h-2Z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">May 14, 2022</span> </span> <span class=md-source-file__fact> <span class=md-icon title=Contributors> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2Z"/></svg> </span> <span>GitHub</span> <nav> <a href=https://github.com/Frichetten class=md-author title=@Frichetten> <img src="https://avatars.githubusercontent.com/u/10386884?size=72" alt=Frichetten> </a> </nav> </span> </aside> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../introduction_user_data/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Introduction to User Data" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> Introduction to User Data </div> </div> </a> <a href=../../enumeration/account_id_from_ec2/ class="md-footer__link md-footer__link--next" aria-label="Next: Enumerate AWS Account ID from an EC2 Instance" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> Enumerate AWS Account ID from an EC2 Instance </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs Insiders </a> </div> <div class=md-social> <a href=https://infosec.exchange/@hackingthecloud target=_blank rel=noopener title=infosec.exchange class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg> </a> <a href=https://twitter.com/Frichette_n target=_blank rel=noopener title=twitter.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg> </a> <a href=https://www.linkedin.com/in/nick-frichette/ target=_blank rel=noopener title=www.linkedin.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg> </a> <a href=https://github.com/Hacking-the-Cloud target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": ["navigation.tabs", "navigation.indexes"], "search": "../../../assets/javascripts/workers/search.939a4419.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script> <script src=../../../assets/javascripts/bundle.02d7801c.min.js></script> <script src=../../../javascripts/matomo.min.js></script> <link rel=stylesheet href=../../../assets/stylesheets/extra.6f22df39.min.css> <script src=../../../assets/javascripts/extra/bundle.6260e174.min.js defer></script> </body> </html>