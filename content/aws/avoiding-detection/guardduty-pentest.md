---
author_name: Nick Frichette
title: Bypass GuardDuty Pentest Findings
description: Prevent Kali Linux, ParrotOS, and Pentoo Linux from throwing GuardDuty alerts by modifying the User Agent string.
hide:
  - toc
---

# Bypass GuardDuty Pentest Findings

When making AWS API requests on common penetration testing OS's GuardDuty will detect this and trigger a [PenTest Finding](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-iam.html#pentest-iam-kalilinux).

This is caused by the user agent name that is passed in the API request. By modifying that we can prevent GuardDuty from detecting that we are operating from a "pentest" Linux distribution.

!!! Warning
    If your assessment requires you to remain undetected it's probably easier to leverage a "safe" OS like Ubuntu, Mac OS, or Windows.

To do this, identify the location of your ```session.py``` in the ```botocore``` package. For example, on a default Kali Linux install it can be found at ```/usr/lib/python3/dist-packages/awscli/botocore/session.py```.

On line [456](https://github.com/boto/botocore/blob/7de36c07ecec503f588ac27658b1795e83b67b75/botocore/session.py#L456) (at the time of writing), you should see the following.

``` py
        if truncate:
            return '%s/%s' % (self.user_agent_name, self.user_agent_version)
        base = '%s/%s Python/%s %s/%s' % (self.user_agent_name,
                                          self.user_agent_version,
                                          platform.python_version(),
                                          platform.system(),
                                          platform.release())
        if os.environ.get('AWS_EXECUTION_ENV') is not None:
            base += ' exec-env/%s' % os.environ.get('AWS_EXECUTION_ENV')
        if self.user_agent_extra:
            base += ' %s' % self.user_agent_extra

        return base
```

To get around this, modify the code and replace it with legitimate user agent strings like those found in [Pacu](https://github.com/RhinoSecurityLabs/pacu/blob/master/pacu/user_agents.txt). With this capability you can mask your user agent to look like anything you want. Even arbitrary values like below.

``` py hl_lines="12 13"
        if truncate:
           return '%s/%s' % (self.user_agent_name, self.user_agent_version)
        base = '%s/%s Python/%s %s/%s' % (self.user_agent_name,
                                          self.user_agent_version,
                                          platform.python_version(),
                                          platform.system(),
                                          platform.release())
        if os.environ.get('AWS_EXECUTION_ENV') is not None:
            base += ' exec-env/%s' % os.environ.get('AWS_EXECUTION_ENV')
        if self.user_agent_extra:
            base += ' %s' % self.user_agent_extra
        # Use any user-agent you wish for detection avoidance.
        base = "Boto3/1.9.106 Python/3.6.7 Linux/4.15.0-48-generic Botocore/1.12.156"

        return base
```

<figure markdown>
  ![lines](/images/aws/avoiding-detection/guardduty-pentest/lines.jpg){ loading=lazy }
</figure>

```platform.system()``` and ```platform.release()``` are similar to ```uname -o``` and ```uname -r```. On a stock Kali install it will generate the following values.

<figure markdown>
  ![example](/images/aws/avoiding-detection/guardduty-pentest/example.png){ loading=lazy }
</figure>

## Validation

Base Kali user-agent output example:

```
$ aws --version
aws-cli/2.12.0 Python/3.11.5 Linux/4.4.0-22621/x86_64.kali.2023 prompt/off
``` 

Modified user-agent output example:

```
$ aws --version
Boto3/1.9.106 Python/3.6.7 Linux/4.15.0-48-generic Botocore/1.12.156
```

<figure markdown>
  ![modified](/images/aws/avoiding-detection/guardduty-pentest/modified.jpg){ loading=lazy }
</figure>