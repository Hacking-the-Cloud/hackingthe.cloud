---
author_name: Nick Frichette
title: AWS IAM Persistence Methods
description: A catalog of methods to maintain access to the AWS control plane.
---

After gaining a foothold in an AWS environment, an attacker may attempt to establish persistence. Doing this will allow them to return to the account later on to continue their activities. This article is a collection of such persistence techniques. It's worth noting at the time of writing, that this is a small subset of the world of possibilities available to an attacker, and more techniques will be added over time.

More complex methods that require additional explanation will link to their respective Hacking the Cloud articles.

## IAM User Access Keys

<div class="grid cards" markdown>

-   :material-alert-decagram:{ .lg .middle } __Technique seen in the wild__

    ---

    - [SCARLETEEL 2.0: Fargate, Kubernetes, and Crypto](https://sysdig.com/blog/scarleteel-2-0/)  
    - [Unmasking GUI-Vil: Financially Motivated Cloud Threat Actor](https://permiso.io/blog/s/unmasking-guivil-new-cloud-threat-actor/)

-   :material-file-document-alert:{ .lg .middle } __Required IAM Permission__

    ---

    - [iam:CreateAccessKey](https://awscli.amazonaws.com/v2/documentation/api/latest/reference/iam/create-access-key.html)

</div>

AWS [IAM users](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users.html) can create pairs of [access keys](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html) to programmatically interact with the AWS API. These credentials can be used with the AWS CLI and allow those with [access](https://hackingthe.cloud/aws/general-knowledge/using_stolen_iam_credentials/) to those credentials to perform actions as the associated user.

Access keys created this way are long lived (starting with [AKIA](https://hackingthe.cloud/aws/general-knowledge/iam-key-identifiers/)), meaning that they do not time out or expire by default. Because of this, creating access keys for a user you'd like to maintain access to can be an incredibly simple and easy form of persistence in an AWS environment.

!!! Tip
    Aside from the opportunity to maintain persistence in an AWS environment, `iam:CreateAccessKey` can also potentially be used for lateral movement to create credentials for other users.

## IAM User Login Profile

<div class="grid cards" markdown>

-   :material-alert-decagram:{ .lg .middle } __Technique seen in the wild__

    ---

    - [Unmasking GUI-Vil: Financially Motivated Cloud Threat Actor](https://permiso.io/blog/s/unmasking-guivil-new-cloud-threat-actor/)

-   :material-file-document-alert:{ .lg .middle } __Required IAM Permission__

    ---

    - [iam:CreateLoginProfile](https://awscli.amazonaws.com/v2/documentation/api/latest/reference/iam/create-login-profile.html)

</div>

AWS [IAM users](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users.html) can be configured to access the AWS console with a username and password. An adversary with the `iam:CreateLoginProfile` permission can create login profiles for other users (specifying the password of their choosing). Through this method an adversary can maintain access to an IAM user by logging into the AWS console and performing operations from there.

## IAM Role Assume Role Policy 

<div class="grid cards" markdown>

-   :material-file-document-alert:{ .lg .middle } __Required IAM Permission__

    ---

    - [iam:UpdateAssumeRolePolicy](https://awscli.amazonaws.com/v2/documentation/api/latest/reference/iam/update-assume-role-policy.html)

</div>

In order to assume an [IAM role](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles.html), a [role trust policy](https://docs.aws.amazon.com/workdocs/latest/developerguide/wd-iam-grantdev.html) must be attached to it. This policy specifies the identities that are permitted to assume the role.

An adversary could invoke `iam:UpdateAssumeRolePolicy`, specifying that their own, attacker-controlled AWS account is permitted to assume the role in the environment. This would allow the adversary to maintain access to that role, and use it when needed.

```json
{
  "Version": "2012-10-17",
  "Statement": {
    "Effect": "Allow",
    "Action": "sts:AssumeRole",
    "Resource": "arn:aws:iam::<attacker_aws_account_id>:role/secret_admin"
  }
}
```

!!! Tip
    For the defensive side; it is a good idea to regularly audit role trust policies that establish trust with AWS accounts outside of your organization. In most cases, this will likely identify SaaS and vendor [AWS accounts](https://github.com/fwdcloudsec/known_aws_accounts), however it may turn up something much more nefarious.


## Survive Access Key Deletion with sts:GetFederationToken 

<div class="grid cards" markdown>

-   :material-link-box-outline:{ .lg .middle } __Technique Article__

    ---

    - [Survive Access Key Deletion with sts:GetFederationToken](https://hackingthe.cloud/aws/post_exploitation/survive_access_key_deletion_with_sts_getfederationtoken/)

</div>

## EC2 Instance Persistence

EC2 instances which have an IAM role attached to them will have their own [instance metadata service](https://hackingthe.cloud/aws/general-knowledge/intro_metadata_service/) (IMDS) available. If an adversary has code execution on the EC2 instance, or is able to abuse [server side request forgery](https://hackingthe.cloud/aws/exploitation/ec2-metadata-ssrf/) in an application running on the host, they can steal IAM credentials from the IMDS.

By maintaining access to an EC2 instance which has a role with the permissions you want, this can be an effective and quiet method to keep access to an AWS environment. No additional API calls are required to use those credentials.

## Lambda Persistence

<div class="grid cards" markdown>

-   :material-link-box-outline:{ .lg .middle } __Technique Article__

    ---

    - [Lambda Persistence](https://hackingthe.cloud/aws/post_exploitation/lambda_persistence/)
</div>

## User Data Script Persistence

<div class="grid cards" markdown>
-   :material-link-box-outline:{ .lg .middle } __Technique Article__

    ---

    - [User Data Script Persistence](https://hackingthe.cloud/aws/post_exploitation/user_data_script_persistence/)
</div>